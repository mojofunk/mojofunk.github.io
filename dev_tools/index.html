<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

<section data-markdown>
	<textarea data-template>
## Instrumenting Ardour
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Ardour

- Open Source Digital Audio Workstation(DAW)
- Cross platform (primarily Linux, macOS, Windows)
- Small developer community
- Commercial derivatives (Harrison Mixbus, Waves Tracks)
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Ardour Implementation

- Written in C++(98)
- Heavily multi-threaded
- Separation of GUI and logic/backend
- Asyncronous events/signals
- Large internal set of libraries (20+)
- Many external library dependencies (80+)
- Loadable modules/plugins (LADSPA, LV2, VST)
	</textarea>
</section>

<section data-markdown data-separator-notes="^Note:">

	<textarea data-template>
### Instrumentation

- Execution tracing
- General logging
- Performance measurments
- Memory analysis
- Code coverage/SCI

Note: instrumentation refers to an ability to monitor or measure the
level of a product's performance, to diagnose errors and to write trace
information. --Wikipedia
	</textarea>

</section>

<section data-markdown data-separator-notes="^Note:">
	<textarea data-template>
### Ardour Debugging

- Inspection
- DEBUG_TRACE
- gdb
- valgrind
- sysprof
- MSVC?
- XCode/Instruments?

	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### DEBUG_TRACE

- printf like macro outputs debug category and string to stdout
- String formatting with string_compose() template that uses
std::ostringstream internally
- Enabled via command line
- Only included in debug builds
	</textarea>
</section>

<section data-markdown data-separator-notes="^Note:">
	<textarea data-template>

### Developer Tools

- Chrome DevTools
- Firefox Developer Tools
- [Memory and C++ debugging at Electronic Arts](https://www.youtube.com/watch?v=8KIvWJUYbDA)
- [utftrace](https://github.com/namhyung/uftrace)

Note: ufttrace uses SCI via gcc's/clang profile guided optimization
option and can output instrumentation data such as execution
tracing/timing/function arguments and can output to console or to file
in Trace Event format.
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Ardour Developer Tools

- adt library
- adtmm GUI library 
- A [Trace
Event](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/edit) viewer (Chrome/Chromium)
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### adt

- A C++(11) instrumentation/logging library
- Macro API for conditional compilation in any build
- Lock-free pool based allocation and queuing
- Minimal dependencies([fmt](https://github.com/fmtlib/fmt), [moodycamel](https://github.com/cameron314))
- Trace Event and stdout backends included 
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Controlling Granularity

- Logging categories
- Logging types
 - Messages
 - Function calls
 - Data
 - Allocation
- Presets - Predefined logging category groups
	</textarea>
</section>


<section data-markdown>
	<textarea data-template>
### API styles
	</textarea>
</section>


<section>
<section data-markdown>
	<textarea data-template>
### Log Category API

   - Use a single LogCategory across one or more classes/functions e.g (Render, IO, etc)
   - Good for splitting up i13n/logging in large classes or where functionality spans multiple classes/source files
	</textarea>
</section>
<section>
<p>Header file</p>
<pre>
<code class="stretch">
#include "adt.hpp"

namespace LOG {
	A_DECLARE_LOG_CATEGORY (Transport);
}

</code>
</pre>
</section>

<section>
<p>Source File</p>
<pre>
<code class="stretch">
namespace LOG {
	A_DEFINE_LOG_CATEGORY (Transport, "ARDOUR::Transport");
}
Session::non_realtime_stop (bool abort, int on_entry, bool& finished) {
  A_LOG_CALL2 (LOG::Transport, abort, on_entry);
  {
    A_LOG_DURATION (LOG::Transport, "Locate");
    for (auto& route : route_list) {
      route->non_realtime_locate (_transport_sample);
    }
  }
  ...
  A_LOG_MSG (LOG::Transport,
             A_FMT ("Stop scheduled for next process cycle @ {}", _transport_sample));
  ...
  A_LOG_DATA4 (LOG::Transport, _transport_sample, _transport_speed, play_loop,
               loop_changing);
}
</code>
</pre>
</section>
</section>

<section>
<section data-markdown>
	<textarea data-template>
### Class Members API

   - One LogCategory per class
   - Presets(groups) then used to define association
   - Adds class instance tracking and leak tracing
   - API is more concise as category is implicit
	</textarea>
</section>

<section>
<p>Header file</p>
<pre>
<code class="stretch">
#include "adt.hpp"

namespace ARDOUR {
class AudioSource {
  ...
private:
	A_DECLARE_CLASS_MEMBERS(ARDOUR::AudioSource);
};
} // namespace ARDOUR
</code>
</pre>
</section>

<section>
<p>Source file</p>
<pre>
<code class="stretch">
A_DEFINE_CLASS_MEMBERS (ARDOUR::AudioSource);
int
AudioSource::initialize_peakfile (const string& audio_path, const bool in_session) {
	A_CLASS_CALL2 (audio_path, in_session);
	...
	_peakpath = construct_peak_filepath (audio_path, in_session);
	...
	A_CLASS_DATA1 (_peakpath);
	if (g_stat (_peakpath.c_str(), &statbuf)) {
		...
		A_CLASS_MSG (A_FMT ("Peakfile : {} does not exist", _peakpath));
		...
	} else {
		...
		A_CLASS_MSG (A_FMT ("Peakfile : {} is empty", _peakpath));
	}
}
</code>
</pre>
</section>
</section>


<section data-markdown>
	<textarea data-template>
### adtmm

- An in-process Gtkmm GUI(Developer Tools Window)
- TreeView/Textual based data visualisation
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Trace Event viewer

- Part of Chrome/Chromium
- Accessed via about://tracing 
- Loads Trace Event files recorded by adt
- Graphical based data visualisation
	</textarea>
</section>


<section data-markdown>
	<textarea data-template>
### Examples
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Example : Processing
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Example : Waveform rendering
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Example : Allocation
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Command Line

- Enables recording from start of application execution.
- Enable Log Categories
- Enable Log Types
- Enable Traces
- Enable Leak Tracing
- Enable Presets(TODO)
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Command Line Example
	</textarea>
</section>

<section data-markdown>
	<textarea data-template>
### Summary
- Not on ardour.org repository yet.
- Work still to do (Tests, GUI, User defined presets etc, etc)
- Potentially useful for other C++ based projects.
	</textarea>
</section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
                                ]
			});
		</script>
	</body>
</html>
